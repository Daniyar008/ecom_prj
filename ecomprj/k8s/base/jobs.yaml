# =============================================================================
# Job for Database Migrations (pre-deploy hook)
# =============================================================================
apiVersion: batch/v1
kind: Job
metadata:
  name: django-migrate
  namespace: ecommerce
  labels:
    app.kubernetes.io/name: ecommerce
    app.kubernetes.io/component: migration
  annotations:
    # For Helm hooks
    "helm.sh/hook": pre-upgrade,pre-install
    "helm.sh/hook-weight": "-5"
    "helm.sh/hook-delete-policy": hook-succeeded,before-hook-creation
spec:
  ttlSecondsAfterFinished: 600
  backoffLimit: 3
  template:
    metadata:
      labels:
        app.kubernetes.io/name: ecommerce
        app.kubernetes.io/component: migration
    spec:
      restartPolicy: OnFailure
      initContainers:
        - name: wait-for-postgres
          image: busybox:1.36
          command: ['sh', '-c', 'until nc -z postgres-service 5432; do echo waiting for postgres; sleep 2; done;']
      containers:
        - name: migrate
          image: ${DOCKER_REGISTRY}/ecommerce:${IMAGE_TAG}
          command:
            - python
            - manage.py
            - migrate
            - --noinput
          envFrom:
            - configMapRef:
                name: ecommerce-config
            - secretRef:
                name: ecommerce-secrets
          resources:
            requests:
              cpu: "100m"
              memory: "256Mi"
            limits:
              cpu: "500m"
              memory: "512Mi"
---
# =============================================================================
# Job for Collecting Static Files (pre-deploy hook)
# =============================================================================
apiVersion: batch/v1
kind: Job
metadata:
  name: django-collectstatic
  namespace: ecommerce
  labels:
    app.kubernetes.io/name: ecommerce
    app.kubernetes.io/component: collectstatic
  annotations:
    "helm.sh/hook": pre-upgrade,pre-install
    "helm.sh/hook-weight": "-4"
    "helm.sh/hook-delete-policy": hook-succeeded,before-hook-creation
spec:
  ttlSecondsAfterFinished: 600
  backoffLimit: 3
  template:
    metadata:
      labels:
        app.kubernetes.io/name: ecommerce
        app.kubernetes.io/component: collectstatic
    spec:
      restartPolicy: OnFailure
      containers:
        - name: collectstatic
          image: ${DOCKER_REGISTRY}/ecommerce:${IMAGE_TAG}
          command:
            - python
            - manage.py
            - collectstatic
            - --noinput
          envFrom:
            - configMapRef:
                name: ecommerce-config
            - secretRef:
                name: ecommerce-secrets
          volumeMounts:
            - name: static-volume
              mountPath: /app/staticfiles
          resources:
            requests:
              cpu: "100m"
              memory: "256Mi"
            limits:
              cpu: "500m"
              memory: "512Mi"
      volumes:
        - name: static-volume
          persistentVolumeClaim:
            claimName: static-pvc
---
# =============================================================================
# Job for Creating Superuser (optional, post-deploy)
# =============================================================================
apiVersion: batch/v1
kind: Job
metadata:
  name: django-createsuperuser
  namespace: ecommerce
  labels:
    app.kubernetes.io/name: ecommerce
    app.kubernetes.io/component: setup
  annotations:
    "helm.sh/hook": post-install
    "helm.sh/hook-weight": "1"
    "helm.sh/hook-delete-policy": hook-succeeded,before-hook-creation
spec:
  ttlSecondsAfterFinished: 600
  backoffLimit: 1
  template:
    metadata:
      labels:
        app.kubernetes.io/name: ecommerce
        app.kubernetes.io/component: setup
    spec:
      restartPolicy: Never
      containers:
        - name: createsuperuser
          image: ${DOCKER_REGISTRY}/ecommerce:${IMAGE_TAG}
          command:
            - /bin/sh
            - -c
            - |
              python manage.py shell << 'EOF'
              from django.contrib.auth import get_user_model
              import os
              User = get_user_model()
              username = os.environ.get('DJANGO_SUPERUSER_USERNAME', 'admin')
              email = os.environ.get('DJANGO_SUPERUSER_EMAIL', 'admin@example.com')
              password = os.environ.get('DJANGO_SUPERUSER_PASSWORD', 'changeme123')
              if not User.objects.filter(username=username).exists():
                  User.objects.create_superuser(username, email, password)
                  print(f'Superuser {username} created!')
              else:
                  print(f'Superuser {username} already exists.')
              EOF
          envFrom:
            - configMapRef:
                name: ecommerce-config
            - secretRef:
                name: ecommerce-secrets
          resources:
            requests:
              cpu: "50m"
              memory: "128Mi"
            limits:
              cpu: "200m"
              memory: "256Mi"
